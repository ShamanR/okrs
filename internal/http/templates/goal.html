{{define "goal-content"}}
<nav class="mb-4" aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/teams">Команды</a></li>
    <li class="breadcrumb-item">
      <a href="/teams/{{.Team.ID}}/okr?year={{.Goal.Year}}&quarter={{.Goal.Quarter}}">
        <span class="badge text-bg-secondary">{{.TeamTypeLabel}}</span>
        {{.Team.Name}}
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">{{.Goal.Title}}</li>
  </ol>
</nav>

{{if .FormError}}
  <div class="alert alert-danger py-2">{{.FormError}}</div>
{{end}}
{{if .IsClosed}}
  <div class="alert alert-warning py-2">Квартал закрыт, изменения недоступны.</div>
{{end}}

{{if .UseObjectiveUIV2}}
<div class="card mb-4">
  <div class="card-body">
    <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
      <h2 class="h4 mb-0">{{.Goal.Title}}</h2>
      <span class="badge {{priorityBadgeClass .Goal.Priority}}">{{.Goal.Priority}}</span>
      <span class="badge text-bg-light border">Вес, % {{.Goal.Weight}}</span>
      <span class="badge {{.ObjectiveStatus.BadgeClass}}">{{.ObjectiveStatus.Label}}</span>
      <span class="badge text-bg-light border">Прогресс {{.Goal.Progress}}%</span>
      <span class="text-muted small">Взвешенно по KR</span>
      <button type="button" class="btn btn-outline-secondary btn-sm" data-okr-popover="goal-progress-popover" aria-label="Пояснение прогресса">i</button>
    </div>
    <div id="goal-progress-popover" class="d-none">
      <div class="small text-muted mb-2">Формула: Σ(вес_KR × прогресс_KR) / Σ(вес_KR)</div>
      <div class="table-responsive">
        <table class="table table-sm mb-0">
          <thead>
            <tr>
              <th scope="col">KR</th>
              <th scope="col">Вес, %</th>
              <th scope="col">Прогресс</th>
              <th scope="col">Вклад, п.п.</th>
            </tr>
          </thead>
          <tbody>
            {{range .KRBreakdown}}
              <tr>
                <td class="text-break">{{.Title}}</td>
                <td>{{.Weight}}</td>
                <td>{{.Progress}}%</td>
                <td>{{.Contribution}}</td>
              </tr>
            {{end}}
          </tbody>
        </table>
      </div>
    </div>
    <p class="text-muted mb-2">{{.Goal.Description}}</p>
    <p class="mb-2">Направление: {{workTypeLabel .Goal.WorkType}} | Фокус: {{focusTypeLabel .Goal.FocusType}} | Владелец: {{.Goal.OwnerText}}</p>
    <div class="small text-muted" title="{{absoluteTime .Goal.UpdatedAt}}" data-bs-toggle="tooltip">Обновлено {{relativeTime .Goal.UpdatedAt}}</div>
    {{if .LastStatusUpdate}}
      <div class="border rounded p-3 mt-3 bg-light">
        <div class="row g-3">
          <div class="col-md-4">
            <div class="small text-muted">Что изменилось</div>
            <div>{{if .LastStatusUpdate.UpdateFields.Changed}}{{.LastStatusUpdate.UpdateFields.Changed}}{{else}}—{{end}}</div>
          </div>
          <div class="col-md-4">
            <div class="small text-muted">Что блокирует</div>
            <div>{{if .LastStatusUpdate.UpdateFields.Blockers}}{{.LastStatusUpdate.UpdateFields.Blockers}}{{else}}—{{end}}</div>
          </div>
          <div class="col-md-4">
            <div class="small text-muted">Следующий шаг</div>
            <div>{{if .LastStatusUpdate.UpdateFields.NextStep}}{{.LastStatusUpdate.UpdateFields.NextStep}}{{else}}—{{end}}</div>
          </div>
        </div>
      </div>
    {{end}}
    <div class="mt-3">
      <form method="post" action="/goals/{{.Goal.ID}}/delete" class="m-0">
        <button type="submit" class="btn btn-outline-danger btn-sm" {{if .IsClosed}}disabled{{end}}>Удалить цель</button>
      </form>
    </div>
  </div>
</div>

<div class="row g-4 mb-4">
  <div class="col-lg-5">
    <div class="card">
      <div class="card-body">
        <h3 class="h5">Добавить комментарий</h3>
        <form method="post" action="/goals/{{.Goal.ID}}/comments" class="mb-3" data-comment-form>
          <input type="hidden" name="comment_type" value="comment" data-comment-type>
          <div class="btn-group btn-group-sm mb-3" role="group" aria-label="Тип комментария">
            <input type="radio" class="btn-check" name="comment_type_toggle" id="commentRegular" autocomplete="off" checked>
            <label class="btn btn-outline-secondary" for="commentRegular">Обычный комментарий</label>
            <input type="radio" class="btn-check" name="comment_type_toggle" id="commentStatus" autocomplete="off">
            <label class="btn btn-outline-secondary" for="commentStatus">Апдейт статуса</label>
          </div>
          <div data-comment-regular>
            <textarea class="form-control mb-2" name="text" rows="4" placeholder="Что изменилось?
Что блокирует?
Следующий шаг (и кто владелец)?
Нужна помощь от…" required></textarea>
          </div>
          <div class="d-none" data-comment-status>
            <div class="mb-2">
              <label class="form-label">Что изменилось</label>
              <textarea class="form-control" name="status_changed" rows="2"></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label">Что блокирует</label>
              <textarea class="form-control" name="status_blockers" rows="2"></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label">Следующий шаг (и кто владелец)</label>
              <textarea class="form-control" name="status_next" rows="2"></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label">Нужна помощь от…</label>
              <textarea class="form-control" name="status_help" rows="2"></textarea>
            </div>
          </div>
          <button type="submit" class="btn btn-outline-primary btn-sm">Добавить</button>
        </form>
        {{range .GoalComments}}
          <div class="border rounded p-2 mb-2 bg-light">
            <div class="small text-muted" title="{{absoluteTime .CreatedAt}}" data-bs-toggle="tooltip">{{relativeTime .CreatedAt}}</div>
            {{if .IsStatusUpdate}}
              <div class="small text-muted">Апдейт статуса</div>
              <div class="mt-1"><strong>Что изменилось:</strong> {{if .UpdateFields.Changed}}{{.UpdateFields.Changed}}{{else}}—{{end}}</div>
              <div><strong>Что блокирует:</strong> {{if .UpdateFields.Blockers}}{{.UpdateFields.Blockers}}{{else}}—{{end}}</div>
              <div><strong>Следующий шаг:</strong> {{if .UpdateFields.NextStep}}{{.UpdateFields.NextStep}}{{else}}—{{end}}</div>
              {{if .UpdateFields.Help}}
                <div><strong>Нужна помощь от:</strong> {{.UpdateFields.Help}}</div>
              {{end}}
            {{else}}
              <div>{{.Text}}</div>
            {{end}}
          </div>
        {{end}}
      </div>
    </div>
  </div>
  <div class="col-lg-7">
    <div class="card">
      <div class="card-body">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
          <h3 class="h5 mb-0">Добавить KR</h3>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#krCreateModal">Добавить KR</button>
        </div>
        {{if .Goal.KeyResults}}
          <div class="mt-3">
            {{if .KRWeightsMismatch}}
              <div class="d-flex flex-wrap align-items-center gap-2 text-warning">
                <span>⚠️ Сумма весов: {{.KRWeightsSum}}%</span>
                <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#krWeightsModal">Исправить</button>
              </div>
            {{else}}
              <div class="text-success">✅ Сумма весов: 100%</div>
            {{end}}
          </div>
        {{end}}
      </div>
    </div>
  </div>
</div>

<h2 class="h4 mb-3">Ключевые результаты</h2>
<div class="vstack gap-3">
{{range .Goal.KeyResults}}
  <div class="card">
    <div class="card-body">
      <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
        <h3 class="h5 mb-0">{{.Title}}</h3>
        <span class="badge text-bg-secondary">{{krKindLabel .Kind}}</span>
        <span class="badge text-bg-light border">Вес, % {{.Weight}}</span>
        <span class="badge text-bg-light border">Прогресс {{.Progress}}%</span>
        <div class="ms-auto d-flex align-items-center gap-2">
          <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#krEditModal-{{.ID}}" {{if $.IsClosed}}disabled{{end}}>Обновить прогресс</button>
          <div class="dropdown">
            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">⋯</button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li>
                <button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#krEditModal-{{.ID}}">Редактировать</button>
              </li>
              <li>
                <form method="post" action="/key-results/{{.ID}}/move-up" class="m-0">
                  <input type="hidden" name="return" value="/goals/{{$.Goal.ID}}">
                  <button type="submit" class="dropdown-item">Переместить вверх</button>
                </form>
              </li>
              <li>
                <form method="post" action="/key-results/{{.ID}}/move-down" class="m-0">
                  <input type="hidden" name="return" value="/goals/{{$.Goal.ID}}">
                  <button type="submit" class="dropdown-item">Переместить вниз</button>
                </form>
              </li>
              <li>
                <button class="dropdown-item text-danger" data-bs-toggle="modal" data-bs-target="#krDeleteModal-{{.ID}}">Удалить</button>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <p class="text-muted">{{.Description}}</p>
      <div class="border-top pt-3">
        <div class="row g-2 small text-muted">
          <div class="col-md-3">Текущее / Цель: {{krMetricSummary .}}</div>
          <div class="col-md-3">Владелец: —</div>
          <div class="col-md-3">Источник: —</div>
          <div class="col-md-3" title="{{absoluteTime .UpdatedAt}}" data-bs-toggle="tooltip">Обновлено {{relativeTime .UpdatedAt}}</div>
        </div>
      </div>

      {{if eq .Kind "PROJECT"}}
        <div class="border-top pt-3">
          {{if .Project}}
            {{ $stageWeight := sumStageWeights .Project.Stages }}
            <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
              <h4 class="h6 mb-0">Этапы проекта</h4>
              <span class="badge {{if ne $stageWeight 100}}text-bg-danger{{else}}text-bg-light border{{end}}" {{if ne $stageWeight 100}}title="Сумма весов шагов должна быть равна 100"{{end}}>
                Сумма шагов {{ $stageWeight }}
              </span>
            </div>
          {{else}}
            <h4 class="h6">Этапы проекта</h4>
          {{end}}
          <ul class="list-group">
            {{if .Project}}
              {{range .Project.Stages}}
                <li class="list-group-item d-flex align-items-center gap-2">
                  <span class="flex-grow-1">{{.Title}}</span>
                  <span class="badge text-bg-light border">{{.Weight}}%</span>
                  <span class="badge {{if .IsDone}}text-bg-success{{else}}text-bg-secondary{{end}}">{{if .IsDone}}Готово{{else}}В работе{{end}}</span>
                </li>
              {{end}}
            {{else}}
              <li class="list-group-item text-muted">Шаги не заданы</li>
            {{end}}
          </ul>
        </div>
      {{end}}

      {{if eq .Kind "PERCENT"}}
        <div class="border-top pt-3">
          <h4 class="h6">Метрика</h4>
          {{with .Percent}}
            <p class="text-muted">Старт: {{.StartValue}} → Цель: {{.TargetValue}} | Текущее: {{.CurrentValue}}</p>
          {{end}}
        </div>
      {{end}}

      {{if eq .Kind "BOOLEAN"}}
        <div class="border-top pt-3">
          <p class="text-muted">Статус: {{if .Boolean}}{{if .Boolean.IsDone}}Да{{else}}Нет{{end}}{{else}}Нет{{end}}</p>
        </div>
      {{end}}

      <div class="border-top pt-3">
        <h4 class="h6">Комментарии KR</h4>
        <form method="post" action="/key-results/{{.ID}}/comments" class="mb-3">
          <textarea class="form-control mb-2" name="text" rows="2" required></textarea>
          <button type="submit" class="btn btn-outline-primary btn-sm">Добавить</button>
        </form>
        {{range .Comments}}
          <div class="border rounded p-2 mb-2 bg-light">
            <div class="small text-muted">{{.CreatedAt.Format "2006-01-02 15:04"}}</div>
            <div>{{.Text}}</div>
          </div>
        {{end}}
      </div>
    </div>
  </div>

  <div class="modal fade" id="krDeleteModal-{{.ID}}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Удалить KR</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Удалить KR «{{.Title}}»? Это действие нельзя отменить.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
          <form method="post" action="/key-results/{{.ID}}/delete" class="m-0">
            <button type="submit" class="btn btn-danger">Удалить</button>
          </form>
        </div>
      </div>
    </div>
  </div>
{{end}}
</div>

{{if .Goal.KeyResults}}
<div class="modal fade" id="krWeightsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Исправить веса KR</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="post" action="/goals/{{.Goal.ID}}/weights" data-weights-form>
          <div class="vstack gap-3">
            {{range .Goal.KeyResults}}
              <div class="row g-3 align-items-center">
                <div class="col-md-7">
                  <div class="fw-semibold text-break">{{.Title}}</div>
                </div>
                <div class="col-md-5">
                  <div class="input-group">
                    <input class="form-control" type="number" min="0" max="100" name="weight_{{.ID}}" value="{{.Weight}}" data-weight-input>
                    <span class="input-group-text">%</span>
                  </div>
                </div>
              </div>
            {{end}}
          </div>
          <div class="d-flex flex-wrap align-items-center gap-2 mt-3">
            <button type="button" class="btn btn-outline-secondary btn-sm" data-normalize-weights>Нормализовать до 100%</button>
            <div class="text-muted small" data-weights-total>Сумма: {{.KRWeightsSum}}%</div>
          </div>
          <div class="modal-footer px-0">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
            <button type="submit" class="btn btn-primary">Сохранить</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{{end}}
{{else}}
<div class="card mb-4">
  <div class="card-body">
    <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
      <h2 class="h4 mb-0">{{.Goal.Title}}</h2>
      <span class="badge {{priorityBadgeClass .Goal.Priority}}">{{.Goal.Priority}}</span>
      <span class="badge text-bg-light border">Вес {{.Goal.Weight}}</span>
      <span class="badge text-bg-light border">Прогресс {{.Goal.Progress}}%</span>
    </div>
    <p class="text-muted mb-2">{{.Goal.Description}}</p>
    <p class="mb-0">Work: {{.Goal.WorkType}} | Focus: {{.Goal.FocusType}} | Owner: {{.Goal.OwnerText}}</p>
    <div class="mt-3">
      <form method="post" action="/goals/{{.Goal.ID}}/delete" class="m-0">
        <button type="submit" class="btn btn-outline-danger btn-sm" {{if .IsClosed}}disabled{{end}}>Удалить цель</button>
      </form>
    </div>
  </div>
</div>

<div class="row g-4 mb-4">
  <div class="col-lg-5">
    <div class="card">
      <div class="card-body">
        <h3 class="h5">Добавить комментарий</h3>
        <form method="post" action="/goals/{{.Goal.ID}}/comments" class="mb-3">
          <textarea class="form-control mb-2" name="text" rows="3" required></textarea>
          <button type="submit" class="btn btn-outline-primary btn-sm">Добавить</button>
        </form>
        {{range .Goal.Comments}}
          <div class="border rounded p-2 mb-2 bg-light">
            <div class="small text-muted">{{.CreatedAt.Format "2006-01-02 15:04"}}</div>
            <div>{{.Text}}</div>
          </div>
        {{end}}
      </div>
    </div>
  </div>
  <div class="col-lg-7">
    <div class="card">
      <div class="card-body">
        <h3 class="h5">Добавить Key Result</h3>
        {{if .FormError}}<div class="alert alert-danger py-2">{{.FormError}}</div>{{end}}
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#krCreateModal">Добавить KR</button>
      </div>
    </div>
  </div>
</div>

<h2 class="h4 mb-3">Key Results</h2>
{{ $krWeight := sumKRWeights .Goal.KeyResults }}
{{if .Goal.KeyResults}}
  <div class="mb-3">
    <span class="badge {{if ne $krWeight 100}}text-bg-danger{{else}}text-bg-light border{{end}}" {{if ne $krWeight 100}}title="Сумма весов KR должна быть равна 100"{{end}}>
      Сумма KR {{ $krWeight }}
    </span>
  </div>
{{end}}
<div class="vstack gap-3">
{{range .Goal.KeyResults}}
  <div class="card">
    <div class="card-body">
      <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
        <h3 class="h5 mb-0">{{.Title}}</h3>
        <span class="badge text-bg-secondary">{{.Kind}}</span>
        <span class="badge text-bg-light border">Вес {{.Weight}}</span>
        <span class="badge text-bg-light border">Прогресс {{.Progress}}%</span>
        <form method="post" action="/key-results/{{.ID}}/move-up" class="ms-auto">
          <input type="hidden" name="return" value="/goals/{{$.Goal.ID}}">
          <button type="submit" class="btn btn-outline-secondary btn-sm">↑</button>
        </form>
        <form method="post" action="/key-results/{{.ID}}/move-down" class="m-0">
          <input type="hidden" name="return" value="/goals/{{$.Goal.ID}}">
          <button type="submit" class="btn btn-outline-secondary btn-sm">↓</button>
        </form>
      </div>
      <p class="text-muted">{{.Description}}</p>
      <form method="post" action="/key-results/{{.ID}}/delete" class="mb-3">
        <button type="submit" class="btn btn-outline-danger btn-sm">Удалить KR</button>
      </form>
      <button class="btn btn-outline-secondary btn-sm mb-3" data-bs-toggle="modal" data-bs-target="#krEditModal-{{.ID}}">Редактировать KR</button>

      {{if eq .Kind "PROJECT"}}
        <div class="border-top pt-3">
          {{if .Project}}
            {{ $stageWeight := sumStageWeights .Project.Stages }}
            <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
              <h4 class="h6 mb-0">Этапы проекта</h4>
              <span class="badge {{if ne $stageWeight 100}}text-bg-danger{{else}}text-bg-light border{{end}}" {{if ne $stageWeight 100}}title="Сумма весов шагов должна быть равна 100"{{end}}>
                Сумма шагов {{ $stageWeight }}
              </span>
            </div>
          {{else}}
            <h4 class="h6">Этапы проекта</h4>
          {{end}}
          <ul class="list-group">
            {{if .Project}}
              {{range .Project.Stages}}
                <li class="list-group-item d-flex align-items-center gap-2">
                  <span class="flex-grow-1">{{.Title}}</span>
                  <span class="badge text-bg-light border">{{.Weight}}%</span>
                  <span class="badge {{if .IsDone}}text-bg-success{{else}}text-bg-secondary{{end}}">{{if .IsDone}}Done{{else}}In progress{{end}}</span>
                </li>
              {{end}}
            {{else}}
              <li class="list-group-item text-muted">Шаги не заданы</li>
            {{end}}
          </ul>
        </div>
      {{end}}

      {{if eq .Kind "PERCENT"}}
        <div class="border-top pt-3">
          <h4 class="h6">Метрика</h4>
          {{with .Percent}}
            <p class="text-muted">Start: {{.StartValue}} → Target: {{.TargetValue}} | Current: {{.CurrentValue}}</p>
          {{end}}
        </div>
      {{end}}

      {{if eq .Kind "BOOLEAN"}}
        <div class="border-top pt-3">
          <p class="text-muted">Статус: {{if .Boolean}}{{if .Boolean.IsDone}}Да{{else}}Нет{{end}}{{else}}Нет{{end}}</p>
        </div>
      {{end}}

      <div class="border-top pt-3">
        <h4 class="h6">Комментарии KR</h4>
        <form method="post" action="/key-results/{{.ID}}/comments" class="mb-3">
          <textarea class="form-control mb-2" name="text" rows="2" required></textarea>
          <button type="submit" class="btn btn-outline-primary btn-sm">Добавить</button>
        </form>
        {{range .Comments}}
          <div class="border rounded p-2 mb-2 bg-light">
            <div class="small text-muted">{{.CreatedAt.Format "2006-01-02 15:04"}}</div>
            <div>{{.Text}}</div>
          </div>
        {{end}}
      </div>
    </div>
  </div>
{{end}}
</div>
{{end}}

<div class="modal fade" id="krCreateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Новый Key Result</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="post" action="/goals/{{.Goal.ID}}/key-results" class="kr-form autosave-form">
          <div class="autosave-status" data-autosave-status>
            <span class="autosave-dot"></span>
            <span class="autosave-text">Нет несохранённых изменений</span>
          </div>
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Название</label>
              <input class="form-control" name="title" required>
            </div>
            <div class="col-12">
              <label class="form-label">Описание</label>
              <textarea class="form-control" name="description" rows="2"></textarea>
            </div>
            <div class="col-sm-4">
              <label class="form-label">Вес (0-100)</label>
              <input class="form-control" type="number" name="weight" min="0" max="100" value="100">
            </div>
            <div class="col-sm-4">
              <label class="form-label">Тип</label>
              <select class="form-select kr-kind-select" name="kind">
                <option value="PROJECT">Проектный</option>
                <option value="PERCENT">Процентный</option>
                <option value="LINEAR">Линейный</option>
                <option value="BOOLEAN">Булевый</option>
              </select>
              <div class="form-text kr-kind-help"></div>
            </div>
            <div class="col-12 kr-fields kr-percent d-none">
              <div class="row g-3">
                <div class="col-sm-4">
                  <label class="form-label">Старт, %</label>
                  <input class="form-control" type="number" step="0.01" name="percent_start">
                </div>
                <div class="col-sm-4">
                  <label class="form-label">Цель, %</label>
                  <input class="form-control" type="number" step="0.01" name="percent_target">
                </div>
                <div class="col-sm-4">
                  <label class="form-label">Текущее, %</label>
                  <input class="form-control" type="number" step="0.01" name="percent_current">
                </div>
              </div>
            </div>
            <div class="col-12 kr-fields kr-linear d-none">
              <div class="row g-3">
                <div class="col-sm-4">
                  <label class="form-label">Старт</label>
                  <input class="form-control" type="number" step="0.01" name="linear_start">
                </div>
                <div class="col-sm-4">
                  <label class="form-label">Цель</label>
                  <input class="form-control" type="number" step="0.01" name="linear_target">
                </div>
                <div class="col-sm-4">
                  <label class="form-label">Текущее</label>
                  <input class="form-control" type="number" step="0.01" name="linear_current">
                </div>
              </div>
            </div>
            <div class="col-12 kr-fields kr-boolean d-none">
              <label class="form-label">Булевый KR</label>
              <select class="form-select" name="boolean_done">
                <option value="false">Нет</option>
                <option value="true">Да</option>
              </select>
            </div>
            <div class="col-12 kr-fields kr-project d-none">
              <h6>Шаги проекта</h6>
              <div class="vstack gap-2" data-project-steps>
                <div class="row g-2 align-items-end project-step">
                  <div class="col-md-5">
                    <label class="form-label">Название шага</label>
                    <input class="form-control" name="step_title[]">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Вес</label>
                    <input class="form-control" type="number" name="step_weight[]" min="0" max="100">
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">Готово</label>
                    <select class="form-select" name="step_done[]">
                      <option value="false">Нет</option>
                      <option value="true">Да</option>
                    </select>
                  </div>
                  <div class="col-md-2">
                    <button type="button" class="btn btn-outline-danger btn-sm w-100" data-remove-project-step>Удалить</button>
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-outline-secondary btn-sm mt-2" data-add-project-step>+ Добавить шаг</button>
              <template data-project-step-template>
                <div class="row g-2 align-items-end project-step">
                  <div class="col-md-5">
                    <label class="form-label">Название шага</label>
                    <input class="form-control" name="step_title[]">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Вес</label>
                    <input class="form-control" type="number" name="step_weight[]" min="0" max="100">
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">Готово</label>
                    <select class="form-select" name="step_done[]">
                      <option value="false">Нет</option>
                      <option value="true">Да</option>
                    </select>
                  </div>
                  <div class="col-md-2">
                    <button type="button" class="btn btn-outline-danger btn-sm w-100" data-remove-project-step>Удалить</button>
                  </div>
                </div>
              </template>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
            <button type="submit" class="btn btn-primary">Сохранить</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{{range .Goal.KeyResults}}
<div class="modal fade" id="krEditModal-{{.ID}}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Редактировать KR</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="post" action="/key-results/{{.ID}}/update" class="kr-form autosave-form">
          <div class="autosave-status" data-autosave-status>
            <span class="autosave-dot"></span>
            <span class="autosave-text">Нет несохранённых изменений</span>
          </div>
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Название</label>
              <input class="form-control" name="title" value="{{.Title}}" required>
            </div>
            <div class="col-12">
              <label class="form-label">Описание</label>
              <textarea class="form-control" name="description" rows="2">{{.Description}}</textarea>
            </div>
            <div class="col-sm-4">
              <label class="form-label">Вес (0-100)</label>
              <input class="form-control" type="number" name="weight" min="0" max="100" value="{{.Weight}}">
            </div>
            <div class="col-sm-4">
              <label class="form-label">Тип</label>
              <select class="form-select kr-kind-select" name="kind" data-current="{{.Kind}}">
                <option value="PROJECT" {{if eq .Kind "PROJECT"}}selected{{end}}>Проектный</option>
                <option value="PERCENT" {{if eq .Kind "PERCENT"}}selected{{end}}>Процентный</option>
                <option value="LINEAR" {{if eq .Kind "LINEAR"}}selected{{end}}>Линейный</option>
                <option value="BOOLEAN" {{if eq .Kind "BOOLEAN"}}selected{{end}}>Булевый</option>
              </select>
              <div class="form-text kr-kind-help"></div>
            </div>
            <div class="col-12 kr-fields kr-percent d-none">
              <div class="row g-3">
                <div class="col-sm-4">
                  <label class="form-label">Старт, %</label>
                  <input class="form-control" type="number" step="0.01" name="percent_start" value="{{if .Percent}}{{.Percent.StartValue}}{{end}}">
                </div>
                <div class="col-sm-4">
                  <label class="form-label">Цель, %</label>
                  <input class="form-control" type="number" step="0.01" name="percent_target" value="{{if .Percent}}{{.Percent.TargetValue}}{{end}}">
                </div>
                <div class="col-sm-4">
                  <label class="form-label">Текущее, %</label>
                  <input class="form-control" type="number" step="0.01" name="percent_current" value="{{if .Percent}}{{.Percent.CurrentValue}}{{end}}">
                </div>
              </div>
            </div>
            <div class="col-12 kr-fields kr-linear d-none">
              <div class="row g-3">
                <div class="col-sm-4">
                  <label class="form-label">Старт</label>
                  <input class="form-control" type="number" step="0.01" name="linear_start" value="{{if .Linear}}{{.Linear.StartValue}}{{end}}">
                </div>
                <div class="col-sm-4">
                  <label class="form-label">Цель</label>
                  <input class="form-control" type="number" step="0.01" name="linear_target" value="{{if .Linear}}{{.Linear.TargetValue}}{{end}}">
                </div>
                <div class="col-sm-4">
                  <label class="form-label">Текущее</label>
                  <input class="form-control" type="number" step="0.01" name="linear_current" value="{{if .Linear}}{{.Linear.CurrentValue}}{{end}}">
                </div>
              </div>
            </div>
            <div class="col-12 kr-fields kr-boolean d-none">
              <label class="form-label">Булевый KR</label>
              <select class="form-select" name="boolean_done">
                <option value="false" {{if .Boolean}}{{if not .Boolean.IsDone}}selected{{end}}{{end}}>Нет</option>
                <option value="true" {{if .Boolean}}{{if .Boolean.IsDone}}selected{{end}}{{end}}>Да</option>
              </select>
            </div>
            <div class="col-12 kr-fields kr-project d-none">
              <h6>Шаги проекта</h6>
                <div class="vstack gap-2" data-project-steps>
                {{if .Project}}
                  {{range $index, $stage := .Project.Stages}}
                    <div class="row g-2 align-items-end project-step">
                      <div class="col-md-5">
                        <label class="form-label">Название шага</label>
                        <input class="form-control" name="step_title[]" value="{{$stage.Title}}">
                      </div>
                      <div class="col-md-3">
                        <label class="form-label">Вес</label>
                        <input class="form-control" type="number" name="step_weight[]" min="0" max="100" value="{{$stage.Weight}}">
                      </div>
                      <div class="col-md-2">
                        <label class="form-label">Готово</label>
                        <select class="form-select" name="step_done[]">
                          <option value="false" {{if not $stage.IsDone}}selected{{end}}>Нет</option>
                          <option value="true" {{if $stage.IsDone}}selected{{end}}>Да</option>
                        </select>
                      </div>
                      <div class="col-md-2">
                        <button type="button" class="btn btn-outline-danger btn-sm w-100" data-remove-project-step>Удалить</button>
                      </div>
                    </div>
                  {{end}}
                {{else}}
                  <div class="row g-2 align-items-end project-step">
                    <div class="col-md-5">
                      <label class="form-label">Название шага</label>
                      <input class="form-control" name="step_title[]">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Вес</label>
                      <input class="form-control" type="number" name="step_weight[]" min="0" max="100">
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Готово</label>
                      <select class="form-select" name="step_done[]">
                        <option value="false">Нет</option>
                        <option value="true">Да</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <button type="button" class="btn btn-outline-danger btn-sm w-100" data-remove-project-step>Удалить</button>
                    </div>
                  </div>
                {{end}}
              </div>
              <button type="button" class="btn btn-outline-secondary btn-sm mt-2" data-add-project-step>+ Добавить шаг</button>
              <template data-project-step-template>
                <div class="row g-2 align-items-end project-step">
                  <div class="col-md-5">
                    <label class="form-label">Название шага</label>
                    <input class="form-control" name="step_title[]">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Вес</label>
                    <input class="form-control" type="number" name="step_weight[]" min="0" max="100">
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">Готово</label>
                    <select class="form-select" name="step_done[]">
                      <option value="false">Нет</option>
                      <option value="true">Да</option>
                    </select>
                  </div>
                  <div class="col-md-2">
                    <button type="button" class="btn btn-outline-danger btn-sm w-100" data-remove-project-step>Удалить</button>
                  </div>
                </div>
              </template>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
            <button type="submit" class="btn btn-primary">Сохранить</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{{end}}

<script>
  const krKindHelpText = {
    BOOLEAN: 'Булевый: бинарный тип. Когда результат либо есть, либо нет. Не имеет промежуточного состояния',
    PERCENT: 'Процентный: результат считается от процентной метрики. Например процент успешных запросов',
    LINEAR: 'Линейный: нарастить показатель от стартового значения до целевого',
    PROJECT: 'Проектный: перечень обязательных шагов и их весов в KR',
  };

  function toggleKrFields(container) {
    const select = container.querySelector('.kr-kind-select');
    if (!select) return;
    const value = select.value;
    container.querySelectorAll('.kr-fields').forEach((block) => {
      block.classList.add('d-none');
    });
    const percent = container.querySelector('.kr-percent');
    const linear = container.querySelector('.kr-linear');
    const boolean = container.querySelector('.kr-boolean');
    const project = container.querySelector('.kr-project');
    if (value === 'PERCENT' && percent) percent.classList.remove('d-none');
    if (value === 'LINEAR' && linear) linear.classList.remove('d-none');
    if (value === 'BOOLEAN' && boolean) boolean.classList.remove('d-none');
    if (value === 'PROJECT' && project) project.classList.remove('d-none');
  }

  function updateKrHelp(container) {
    const select = container.querySelector('.kr-kind-select');
    const help = container.querySelector('.kr-kind-help');
    if (!select || !help) return;
    help.textContent = krKindHelpText[select.value] || '';
  }

  document.querySelectorAll('.kr-form').forEach((form) => {
    const select = form.querySelector('.kr-kind-select');
    if (select) {
      toggleKrFields(form);
      updateKrHelp(form);
      select.addEventListener('change', () => toggleKrFields(form));
      select.addEventListener('change', () => updateKrHelp(form));
    }
  });

  function setupProjectSteps(container) {
    const addButton = container.querySelector('[data-add-project-step]');
    const stepsWrap = container.querySelector('[data-project-steps]');
    const template = container.querySelector('[data-project-step-template]');
    if (!addButton || !stepsWrap || !template) return;
    addButton.addEventListener('click', () => {
      const clone = template.content.cloneNode(true);
      stepsWrap.appendChild(clone);
    });
    stepsWrap.addEventListener('click', (event) => {
      const removeButton = event.target.closest('[data-remove-project-step]');
      if (!removeButton) return;
      const step = removeButton.closest('.project-step');
      if (step) {
        step.remove();
      }
    });
  }

  document.querySelectorAll('.kr-form').forEach((form) => {
    setupProjectSteps(form);
  });

  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach((el) => {
    new bootstrap.Tooltip(el);
  });

  document.querySelectorAll('[data-okr-popover]').forEach((trigger) => {
    const contentId = trigger.getAttribute('data-okr-popover');
    const contentEl = document.getElementById(contentId);
    if (!contentEl) return;
    new bootstrap.Popover(trigger, {
      html: true,
      content: contentEl.innerHTML,
      trigger: 'focus',
    });
  });

  const commentForms = document.querySelectorAll('[data-comment-form]');
  commentForms.forEach((form) => {
    const typeInput = form.querySelector('[data-comment-type]');
    const regularBlock = form.querySelector('[data-comment-regular]');
    const statusBlock = form.querySelector('[data-comment-status]');
    const regularToggle = form.querySelector('#commentRegular');
    const statusToggle = form.querySelector('#commentStatus');

    if (!typeInput || !regularBlock || !statusBlock || !regularToggle || !statusToggle) return;

    const updateVisibility = () => {
      const isStatus = statusToggle.checked;
      typeInput.value = isStatus ? 'status_update' : 'comment';
      regularBlock.classList.toggle('d-none', isStatus);
      statusBlock.classList.toggle('d-none', !isStatus);
      const textarea = regularBlock.querySelector('textarea');
      if (textarea) {
        textarea.required = !isStatus;
      }
    };

    regularToggle.addEventListener('change', updateVisibility);
    statusToggle.addEventListener('change', updateVisibility);
    updateVisibility();
  });

  const weightForms = document.querySelectorAll('[data-weights-form]');
  weightForms.forEach((form) => {
    const inputs = Array.from(form.querySelectorAll('[data-weight-input]'));
    const totalEl = form.querySelector('[data-weights-total]');
    const updateTotal = () => {
      const total = inputs.reduce((sum, input) => sum + (Number(input.value) || 0), 0);
      if (totalEl) {
        totalEl.textContent = `Сумма: ${total}%`;
      }
    };
    inputs.forEach((input) => {
      input.addEventListener('input', updateTotal);
    });
    const normalizeButton = form.querySelector('[data-normalize-weights]');
    if (normalizeButton) {
      normalizeButton.addEventListener('click', () => {
        const values = inputs.map((input) => Math.max(0, Number(input.value) || 0));
        const total = values.reduce((sum, value) => sum + value, 0);
        if (total <= 0) return;
        let remaining = 100;
        inputs.forEach((input, index) => {
          let normalized = Math.round((values[index] / total) * 100);
          if (index === inputs.length - 1) {
            normalized = remaining;
          } else {
            remaining -= normalized;
          }
          input.value = normalized;
        });
        updateTotal();
      });
    }
    updateTotal();
  });
</script>
{{end}}
