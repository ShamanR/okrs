{{define "teams-content"}}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h3 mb-0">Команды</h1>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary btn-sm" href="/goals/year?year={{.CurrentYear}}">Цели за год</a>
    <a class="btn btn-primary btn-sm" href="/teams/new">Новая команда</a>
  </div>
</div>
<form method="get" class="card card-body mb-4">
  <div class="row g-3 align-items-end">
    <div class="col-sm-6 col-md-4">
      <label class="form-label">Квартал</label>
      <select name="quarter" class="form-select">
        {{range .QuarterOptions}}
        <option value="{{.Year}}-{{.Quarter}}" {{if .Selected}}selected{{end}}>{{.Year}} Q{{.Quarter}}</option>
        {{end}}
      </select>
    </div>
    <div class="col-sm-6 col-md-4">
      <label class="form-label">Иерархия</label>
      <select name="team" class="form-select">
        {{range .TeamFilters}}
        <option value="{{.Value}}" {{if .Selected}}selected{{end}}>{{.Label}}</option>
        {{end}}
      </select>
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-primary">Показать</button>
    </div>
  </div>
</form>
<table class="table table-striped align-middle teams-table">
  <thead>
    <tr>
      <th class="teams-col-team">Команда</th>
      <th class="teams-col-progress">Прогресс квартала</th>
      <th class="teams-col-goals">Цели (вес / прогресс)</th>
      <th class="teams-col-status">Статус</th>
      <th class="teams-col-actions">Действия</th>
    </tr>
  </thead>
  <tbody>
    {{range .Teams}}
    <tr>
      <td class="teams-col-team">
        <div class="d-flex align-items-center gap-2" style="padding-left: {{.Indent}}px;">
          <span class="badge text-bg-secondary">{{.TypeLabel}}</span>
          <a class="link-primary"
            href="/teams/{{.ID}}/okr?year={{$.SelectedYear}}&quarter={{$.SelectedQuarter}}">{{.Name}}</a>
        </div>
      </td>
      <td class="teams-col-progress">
        <div class="d-flex align-items-center gap-2">
          <div class="progress flex-grow-1" role="progressbar" aria-valuenow="{{.QuarterProgress}}" aria-valuemin="0"
            aria-valuemax="100">
            <div class="progress-bar" style="width: {{.QuarterProgress}}%"></div>
          </div>
          <span class="fw-semibold">{{.QuarterProgress}}%</span>
        </div>
      </td>
      <td class="teams-col-goals">
        {{if .Goals}}
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0 table-transparent teams-goals-table">
            <thead>
              <tr>
                <th scope="col" class="teams-goals-col-weight">Вес</th>
                <th scope="col" class="teams-goals-col-title">Название цели</th>
                <th scope="col" class="teams-goals-col-progress">Факт(%)</th>
              </tr>
            </thead>
            <tbody>
              {{range .Goals}}
              <tr>
                <td class="teams-goals-col-weight"><span class="badge text-bg-light border">{{.Weight}}</span></td>
                <td class="teams-goals-col-title text-break">
                  <div class="d-flex align-items-center gap-2">
                    <span>{{.Title}}</span>
                    {{if gt (len .ShareTeams) 1}}
                    <button type="button" class="btn btn-link p-0 share-goal-button"
                      data-popover-content="#team-goal-share-{{.ID}}" data-popover-trigger="hoverable"
                      aria-label="Shared goal">
                      <i class="bi bi-share"></i>
                    </button>
                    <div id="team-goal-share-{{.ID}}" class="d-none">
                      <div class="small fw-semibold mb-1">Команды с целью</div>
                      <ul class="list-unstyled mb-0">
                        {{range .ShareTeams}}
                        <li>
                          <a class="text-decoration-none"
                            href="/teams/{{.ID}}/okr?year={{$.SelectedYear}}&quarter={{$.SelectedQuarter}}">
                            <span class="text-muted">{{.TypeLabel}}</span> {{.Name}}
                          </a>
                        </li>
                        {{end}}
                      </ul>
                    </div>
                    {{end}}
                  </div>
                </td>
                <td class="teams-goals-col-progress"><span class="badge text-bg-light border">{{.Progress}}%</span></td>
              </tr>
              {{end}}
            </tbody>
          </table>
        </div>
        <div class="mt-2">
          <span class="badge {{if ne .GoalsWeight 100}}text-bg-danger{{else}}text-bg-light border{{end}}" {{if ne
            .GoalsWeight 100}}title="Сумма весов целей должна быть равна 100" {{end}}>
            Сумма целей {{.GoalsWeight}}
          </span>
        </div>
        {{else}}
        <span class="text-muted">Нет целей</span>
        {{end}}
      </td>
      <td class="teams-col-status">
        <span class="badge text-bg-light border">{{.StatusLabel}}</span>
      </td>
      <td class="teams-col-actions text-end">
        <div class="d-inline-flex gap-2">
          <a class="btn btn-outline-secondary btn-sm" href="/teams/{{.ID}}/edit">Редактировать</a>
          <form method="post" action="/teams/{{.ID}}/delete" class="m-0">
            <button type="submit" class="btn btn-outline-danger btn-sm">Удалить</button>
          </form>
        </div>
      </td>
    </tr>
    {{end}}
  </tbody>
</table>
{{end}}
