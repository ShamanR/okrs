{{define "base"}}
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>{{.PageTitle}}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    :root {
      --okr-surface: #ffffff;
      --okr-border: #e7e9f2;
      --okr-shadow: 0 12px 30px rgba(30, 41, 59, 0.12);
      --okr-primary: #4f46e5;
      --okr-muted: #6b7280;
    }

    body.bg-light {
      background: radial-gradient(circle at top, #f5f7ff 0%, #f8f9fb 40%, #f2f4f8 100%);
    }

    .navbar {
      box-shadow: 0 8px 22px rgba(15, 23, 42, 0.2);
    }

    .card {
      border: 1px solid var(--okr-border);
      border-radius: 18px;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.06);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 32px rgba(15, 23, 42, 0.1);
    }

    .badge {
      border-radius: 999px;
      padding: 0.35rem 0.65rem;
    }

    .btn {
      border-radius: 999px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 14px rgba(15, 23, 42, 0.12);
    }

    .btn-primary {
      background: linear-gradient(135deg, #6366f1, #4f46e5);
      border: none;
    }

    .btn-outline-secondary {
      border-color: #cbd5f5;
      color: #475569;
    }

    .form-control,
    .form-select {
      border-radius: 14px;
      border-color: #e3e6f5;
      padding: 0.65rem 0.9rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: #818cf8;
      box-shadow: 0 0 0 0.2rem rgba(99, 102, 241, 0.2);
    }

    .modal-content {
      border: none;
      border-radius: 22px;
      box-shadow: var(--okr-shadow);
      overflow: hidden;
    }

    .modal-header {
      border-bottom: none;
      padding: 1.6rem 1.8rem 1rem;
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.12), rgba(79, 70, 229, 0.04));
    }

    .modal-title {
      font-weight: 600;
    }

    .modal-body {
      padding: 1.2rem 1.8rem 1.6rem;
    }

    .modal-footer {
      border-top: 1px solid #eef0f6;
      padding: 1rem 1.8rem 1.4rem;
      background: #fafbff;
    }

    .autosave-status {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      border: 1px solid #e5e7f2;
      background: #f8f9ff;
      color: var(--okr-muted);
      font-size: 0.85rem;
      margin-bottom: 1rem;
      transition: color 0.2s ease, border-color 0.2s ease;
    }

    .autosave-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #cbd5f5;
    }

    .autosave-status.is-saving {
      color: #d97706;
      border-color: #fde68a;
    }

    .autosave-status.is-saving .autosave-dot {
      background: #f59e0b;
      animation: pulse 1.2s infinite;
    }

    .autosave-status.is-saved {
      color: #16a34a;
      border-color: #bbf7d0;
    }

    .autosave-status.is-saved .autosave-dot {
      background: #22c55e;
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4);
      }
      70% {
        box-shadow: 0 0 0 6px rgba(245, 158, 11, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(245, 158, 11, 0);
      }
    }

    .list-group-item {
      border-color: #edf0f8;
    }

    .list-group-item:hover {
      background: #f8f9ff;
    }

    .table-transparent {
      --bs-table-bg: transparent;
      --bs-table-striped-bg: transparent;
      --bs-table-active-bg: transparent;
    }

    .table-transparent > :not(caption) > * > * {
      background-color: transparent;
    }

    .teams-table {
      table-layout: fixed;
    }

    .teams-col-team {
      width: 220px;
    }

    .teams-col-progress {
      width: 180px;
    }

    .teams-col-goals {
      width: 600px;
    }

    .teams-col-status {
      width: 150px;
    }

    .teams-col-actions {
      width: 50px;
    }

    .teams-goals-table {
      table-layout: fixed;
      width: 100%;
    }

    .teams-goals-col-weight {
      width: 80px;
    }

    .teams-goals-col-title {
      width: 220px;
    }

    .teams-goals-col-progress {
      width: 40px;
    }

    .weight-mismatch {
      color: #dc3545;
      font-weight: 600;
    }

    .okr-objective-card .okr-info-button {
      text-decoration: none;
      color: #0d6efd;
    }

    .okr-goal-description {
      position: relative;
      white-space: pre-line;
    }

    .okr-goal-description.is-clamped {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      padding-right: 1.5rem;
    }

    .okr-description-toggle {
      position: absolute;
      right: 0;
      bottom: 0;
      border: none;
      background: #fff;
      color: var(--okr-primary);
      padding: 0 0.25rem;
      font-size: 0.85rem;
      line-height: 1.2;
    }

    .okr-kr-item {
      background: #fff;
    }

    .okr-kr-weight {
      min-width: 72px;
    }

    .share-goal-button {
      color: #0d6efd;
      font-size: 1rem;
    }

    .share-goal-button:hover {
      color: #0a58ca;
    }

    .share-goal-badge {
      cursor: pointer;
    }

    .goal-title {
      text-decoration: none;
      color: inherit;
      font-weight: 600;
    }

    .goal-title:hover {
      text-decoration: underline;
    }

    .hierarchy-label {
      white-space: pre;
      font-family: var(--bs-font-monospace);
    }

    .okr-kr-item .collapsing,
    .okr-kr-item .collapse {
      transition-duration: 0.12s;
    }
  </style>
</head>
<body class="bg-light">
<header class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="/teams">OKR Tracker</a>
  </div>
</header>
<main class="container py-4">
  {{.ContentHTML}}
</main>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const autosaveTimers = new WeakMap();

  function updateAutosaveStatus(statusEl, text, className) {
    const textEl = statusEl.querySelector('.autosave-text');
    if (textEl) {
      textEl.textContent = text;
    } else {
      statusEl.textContent = text;
    }
    statusEl.classList.remove('is-saving', 'is-saved');
    if (className) {
      statusEl.classList.add(className);
    }
  }

  function scheduleAutosave(statusEl) {
    if (!statusEl) return;
    const existingTimer = autosaveTimers.get(statusEl);
    if (existingTimer) {
      clearTimeout(existingTimer);
    }
    updateAutosaveStatus(statusEl, 'Автосохранение…', 'is-saving');
    const timer = setTimeout(() => {
      updateAutosaveStatus(statusEl, 'Все изменения сохранены', 'is-saved');
    }, 900);
    autosaveTimers.set(statusEl, timer);
  }

  document.querySelectorAll('form.autosave-form').forEach((form) => {
    const statusEl = form.querySelector('[data-autosave-status]');
    if (!statusEl) return;
    updateAutosaveStatus(statusEl, 'Нет несохранённых изменений');
    form.addEventListener('input', () => scheduleAutosave(statusEl));
    form.addEventListener('change', () => scheduleAutosave(statusEl));
    form.addEventListener('submit', () => {
      updateAutosaveStatus(statusEl, 'Сохраняем…', 'is-saving');
    });
  });

  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach((el) => {
    new bootstrap.Tooltip(el);
  });

  document.querySelectorAll('[data-popover-content]').forEach((el) => {
    const contentEl = document.querySelector(el.getAttribute('data-popover-content'));
    if (!contentEl) return;
    const trigger = el.getAttribute('data-popover-trigger') || 'focus';
    const popover = new bootstrap.Popover(el, {
      html: true,
      trigger: trigger === 'hoverable' ? 'manual' : trigger,
      content: contentEl.innerHTML,
      container: 'body',
    });

    if (trigger === 'hoverable') {
      let hideTimer;
      const clearHideTimer = () => {
        if (hideTimer) {
          clearTimeout(hideTimer);
          hideTimer = null;
        }
      };
      const scheduleHide = () => {
        clearHideTimer();
        hideTimer = setTimeout(() => {
          popover.hide();
        }, 120);
      };
      el.addEventListener('mouseenter', () => {
        clearHideTimer();
        popover.show();
      });
      el.addEventListener('mouseleave', scheduleHide);
      el.addEventListener('shown.bs.popover', () => {
        const popoverId = el.getAttribute('aria-describedby');
        if (!popoverId) return;
        const popoverEl = document.getElementById(popoverId);
        if (!popoverEl) return;
        popoverEl.addEventListener('mouseenter', clearHideTimer);
        popoverEl.addEventListener('mouseleave', scheduleHide);
      });
    }
  });

  function updateMoveControls() {
    const goalCards = Array.from(document.querySelectorAll('[data-goal-card]'));
    goalCards.forEach((card, index) => {
      const isFirst = index === 0;
      const isLast = index === goalCards.length - 1;
      card.querySelectorAll('[data-goal-move="up"]').forEach((btn) => {
        if (isFirst) btn.disabled = true;
      });
      card.querySelectorAll('[data-goal-move="down"]').forEach((btn) => {
        if (isLast) btn.disabled = true;
      });

      const krItems = Array.from(card.querySelectorAll('[data-kr-item]'));
      krItems.forEach((krItem, krIndex) => {
        const krIsFirst = krIndex === 0;
        const krIsLast = krIndex === krItems.length - 1;
        krItem.querySelectorAll('[data-kr-move="up"]').forEach((btn) => {
          if (krIsFirst) btn.disabled = true;
        });
        krItem.querySelectorAll('[data-kr-move="down"]').forEach((btn) => {
          if (krIsLast) btn.disabled = true;
        });
      });
    });
  }

  updateMoveControls();

  function serializeForm(form) {
    const data = new FormData(form);
    const entries = [];
    for (const [key, value] of data.entries()) {
      entries.push([key, value]);
    }
    return JSON.stringify(entries);
  }

  function updateSaveState(form) {
    const saveButton = form.querySelector('[data-kr-save]');
    if (!saveButton) return;
    const dirty = serializeForm(form) !== form.dataset.initialState;
    form.dataset.dirty = dirty ? 'true' : 'false';
    saveButton.disabled = !dirty || !form.checkValidity();
  }

  document.querySelectorAll('[data-kr-progress-form]').forEach((form) => {
    form.dataset.initialState = serializeForm(form);
    updateSaveState(form);
    form.addEventListener('input', () => updateSaveState(form));
    form.addEventListener('change', () => updateSaveState(form));
  });

  const unsavedModalEl = document.getElementById('krUnsavedChangesModal');
  const unsavedModal = unsavedModalEl ? new bootstrap.Modal(unsavedModalEl) : null;
  let pendingPanel = null;

  document.querySelectorAll('[data-kr-panel]').forEach((panel) => {
    panel.addEventListener('show.bs.collapse', (event) => {
      const openPanel = document.querySelector('[data-kr-panel].show');
      if (!openPanel || openPanel === panel) return;
      const dirtyForm = openPanel.querySelector('[data-kr-progress-form][data-dirty="true"]');
      if (dirtyForm && unsavedModal) {
        event.preventDefault();
        pendingPanel = panel;
        unsavedModal.show();
        return;
      }
      bootstrap.Collapse.getOrCreateInstance(openPanel, { toggle: false }).hide();
    });
    panel.addEventListener('hidden.bs.collapse', () => {
      const form = panel.querySelector('[data-kr-progress-form]');
      if (!form) return;
      form.reset();
      form.dataset.initialState = serializeForm(form);
      updateSaveState(form);
    });
  });

  document.querySelectorAll('[data-kr-cancel]').forEach((button) => {
    button.addEventListener('click', () => {
      const panel = button.closest('[data-kr-panel]');
      const form = panel ? panel.querySelector('[data-kr-progress-form]') : null;
      if (!form) return;
      form.reset();
      form.dataset.initialState = serializeForm(form);
      updateSaveState(form);
    });
  });

  const discardButton = document.querySelector('[data-kr-discard]');
  if (discardButton) {
    discardButton.addEventListener('click', () => {
      const openPanel = document.querySelector('[data-kr-panel].show');
      if (openPanel) {
        const form = openPanel.querySelector('[data-kr-progress-form]');
        if (form) {
          form.reset();
          form.dataset.initialState = serializeForm(form);
          updateSaveState(form);
        }
        bootstrap.Collapse.getOrCreateInstance(openPanel, { toggle: false }).hide();
      }
      if (pendingPanel) {
        const target = pendingPanel;
        pendingPanel = null;
        bootstrap.Collapse.getOrCreateInstance(target, { toggle: false }).show();
      }
      if (unsavedModal) {
        unsavedModal.hide();
      }
    });
  }

  document.querySelectorAll('[data-weights-normalize]').forEach((button) => {
    button.addEventListener('click', () => {
      const form = button.closest('form');
      if (!form) return;
      const inputs = Array.from(form.querySelectorAll('input[type="number"][name^="kr_weight_"]'));
      if (!inputs.length) return;
      const values = inputs.map((input) => Math.max(0, Number.parseFloat(input.value) || 0));
      const total = values.reduce((sum, value) => sum + value, 0);
      if (total === 0) return;
      let normalized = values.map((value) => Math.round((value / total) * 100));
      let diff = 100 - normalized.reduce((sum, value) => sum + value, 0);
      let index = 0;
      while (diff !== 0 && normalized.length > 0) {
        normalized[index] += diff > 0 ? 1 : -1;
        diff += diff > 0 ? -1 : 1;
        index = (index + 1) % normalized.length;
      }
      inputs.forEach((input, idx) => {
        input.value = normalized[idx];
      });
    });
  });

  document.querySelectorAll('[data-goal-description]').forEach((description) => {
    const toggle = description.querySelector('[data-goal-description-toggle]');
    if (!toggle) return;
    description.classList.add('is-clamped');
    const isOverflowing = description.scrollHeight > description.clientHeight + 1;
    if (!isOverflowing) {
      description.classList.remove('is-clamped');
      toggle.hidden = true;
      return;
    }
    toggle.hidden = false;
    toggle.addEventListener('click', () => {
      description.classList.remove('is-clamped');
      toggle.hidden = true;
    });
  });
</script>
<script defer src="/static/app.js"></script>
</body>
</html>
{{end}}
